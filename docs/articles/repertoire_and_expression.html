<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Combining Repertoire with Expression with SingleCellExperiment • CellaRepertorium</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Combining Repertoire with Expression with SingleCellExperiment">
<meta property="og:description" content="CellaRepertorium">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">CellaRepertorium</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.7.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/cdr3_clustering.html">Clustering and differential usage of repertoire CDR3 sequences</a>
    </li>
    <li>
      <a href="../articles/cr-overview.html">An Introduction to CellaRepertorium</a>
    </li>
    <li>
      <a href="../articles/mouse_tcell_qc.html">Quality control and Exploration of UMI-based repertoire data</a>
    </li>
    <li>
      <a href="../articles/repertoire_and_expression.html">Combining Repertoire with Expression with SingleCellExperiment</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/amcdavid/CellaRepertorium/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Combining Repertoire with Expression with
SingleCellExperiment</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/amcdavid/CellaRepertorium/blob/HEAD/vignettes/repertoire_and_expression.Rmd" class="external-link"><code>vignettes/repertoire_and_expression.Rmd</code></a></small>
      <div class="hidden name"><code>repertoire_and_expression.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/amcdavid/CellaRepertorium" class="external-link">CellaRepertorium</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">SingleCellExperiment</span><span class="op">)</span>
<span class="co">#&gt; Loading required package: SummarizedExperiment</span>
<span class="co">#&gt; Loading required package: MatrixGenerics</span>
<span class="co">#&gt; Loading required package: matrixStats</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'MatrixGenerics'</span>
<span class="co">#&gt; The following objects are masked from 'package:matrixStats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     colAlls, colAnyNAs, colAnys, colAvgsPerRowSet, colCollapse,</span>
<span class="co">#&gt;     colCounts, colCummaxs, colCummins, colCumprods, colCumsums,</span>
<span class="co">#&gt;     colDiffs, colIQRDiffs, colIQRs, colLogSumExps, colMadDiffs,</span>
<span class="co">#&gt;     colMads, colMaxs, colMeans2, colMedians, colMins, colOrderStats,</span>
<span class="co">#&gt;     colProds, colQuantiles, colRanges, colRanks, colSdDiffs, colSds,</span>
<span class="co">#&gt;     colSums2, colTabulates, colVarDiffs, colVars, colWeightedMads,</span>
<span class="co">#&gt;     colWeightedMeans, colWeightedMedians, colWeightedSds,</span>
<span class="co">#&gt;     colWeightedVars, rowAlls, rowAnyNAs, rowAnys, rowAvgsPerColSet,</span>
<span class="co">#&gt;     rowCollapse, rowCounts, rowCummaxs, rowCummins, rowCumprods,</span>
<span class="co">#&gt;     rowCumsums, rowDiffs, rowIQRDiffs, rowIQRs, rowLogSumExps,</span>
<span class="co">#&gt;     rowMadDiffs, rowMads, rowMaxs, rowMeans2, rowMedians, rowMins,</span>
<span class="co">#&gt;     rowOrderStats, rowProds, rowQuantiles, rowRanges, rowRanks,</span>
<span class="co">#&gt;     rowSdDiffs, rowSds, rowSums2, rowTabulates, rowVarDiffs, rowVars,</span>
<span class="co">#&gt;     rowWeightedMads, rowWeightedMeans, rowWeightedMedians,</span>
<span class="co">#&gt;     rowWeightedSds, rowWeightedVars</span>
<span class="co">#&gt; Loading required package: GenomicRanges</span>
<span class="co">#&gt; Loading required package: stats4</span>
<span class="co">#&gt; Loading required package: BiocGenerics</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'BiocGenerics'</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     IQR, mad, sd, var, xtabs</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     anyDuplicated, append, as.data.frame, basename, cbind, colnames,</span>
<span class="co">#&gt;     dirname, do.call, duplicated, eval, evalq, Filter, Find, get, grep,</span>
<span class="co">#&gt;     grepl, intersect, is.unsorted, lapply, Map, mapply, match, mget,</span>
<span class="co">#&gt;     order, paste, pmax, pmax.int, pmin, pmin.int, Position, rank,</span>
<span class="co">#&gt;     rbind, Reduce, rownames, sapply, setdiff, sort, table, tapply,</span>
<span class="co">#&gt;     union, unique, unsplit, which.max, which.min</span>
<span class="co">#&gt; Loading required package: S4Vectors</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'S4Vectors'</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     expand.grid, I, unname</span>
<span class="co">#&gt; Loading required package: IRanges</span>
<span class="co">#&gt; Loading required package: GenomeInfoDb</span>
<span class="co">#&gt; Loading required package: Biobase</span>
<span class="co">#&gt; Welcome to Bioconductor</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     Vignettes contain introductory material; view with</span>
<span class="co">#&gt;     'browseVignettes()'. To cite Bioconductor, see</span>
<span class="co">#&gt;     'citation("Biobase")', and for packages 'citation("pkgname")'.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'Biobase'</span>
<span class="co">#&gt; The following object is masked from 'package:MatrixGenerics':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     rowMedians</span>
<span class="co">#&gt; The following objects are masked from 'package:matrixStats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     anyMissing, rowMedians</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'dplyr'</span>
<span class="co">#&gt; The following object is masked from 'package:Biobase':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     combine</span>
<span class="co">#&gt; The following objects are masked from 'package:GenomicRanges':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, setdiff, union</span>
<span class="co">#&gt; The following object is masked from 'package:GenomeInfoDb':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect</span>
<span class="co">#&gt; The following objects are masked from 'package:IRanges':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     collapse, desc, intersect, setdiff, slice, union</span>
<span class="co">#&gt; The following objects are masked from 'package:S4Vectors':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     first, intersect, rename, setdiff, setequal, union</span>
<span class="co">#&gt; The following objects are masked from 'package:BiocGenerics':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     combine, intersect, setdiff, union</span>
<span class="co">#&gt; The following object is masked from 'package:matrixStats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     count</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter, lag</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, setdiff, setequal, union</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org" class="external-link">readr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'tidyr'</span>
<span class="co">#&gt; The following object is masked from 'package:S4Vectors':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     expand</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://purrr.tidyverse.org" class="external-link">purrr</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'purrr'</span>
<span class="co">#&gt; The following object is masked from 'package:GenomicRanges':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     reduce</span>
<span class="co">#&gt; The following object is masked from 'package:IRanges':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     reduce</span></code></pre></div>
<p>It is possible to combine <code>ContigCellDB</code> objects with
<code>SingleCellExperiment</code> objects that measure overlapping
barcodes. We choose to include the <code>ContigCellDB</code> object as a
member of the <code>colData</code>. In this way, it is possible to
include different cellular “views” of the repertoire, such as the alpha
chain and beta chain properties, as well as the paired clonotypes.</p>
<div class="section level2">
<h2 id="load-expression">“Load” expression<a class="anchor" aria-label="anchor" href="#load-expression"></a>
</h2>
<p>First we’ll cook up some single cell expression data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1345</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">ccdb_ex</span><span class="op">)</span>
<span class="va">barcodes</span> <span class="op">=</span> <span class="va">ccdb_ex</span><span class="op">$</span><span class="va">cell_tbl</span><span class="op">[</span><span class="va">ccdb_ex</span><span class="op">$</span><span class="va">cell_pk</span><span class="op">]</span>

<span class="co"># Take a subsample of almost all of the barcdes</span>
<span class="va">barcodes</span> <span class="op">=</span> <span class="va">barcodes</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">barcodes</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">barcodes</span><span class="op">)</span> <span class="op">-</span> <span class="fl">5</span><span class="op">)</span>,<span class="op">]</span>
<span class="va">samples</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">ccdb_ex</span><span class="op">$</span><span class="va">cell_tbl</span><span class="op">[</span><span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="va">ccdb_ex</span><span class="op">$</span><span class="va">cell_pk</span>, <span class="st">'barcode'</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>

<span class="co"># For each sample, generate  0-100 "extra" barcodes for which only 5' expression is recovered</span>
<span class="va">extra</span> <span class="op">=</span> <span class="va">samples</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html" class="external-link">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>extrabc <span class="op">=</span> <span class="op">{</span>
  <span class="va">extra_bc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>barcode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'barcode'</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">extra_bc</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span> 
<span class="va">extra</span> <span class="op">=</span> <span class="va">extra</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html" class="external-link">c</a></span><span class="op">(</span><span class="va">extrabc</span><span class="op">)</span><span class="op">)</span>
<span class="va">all_bc</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">extra</span>, <span class="va">barcodes</span><span class="op">)</span></code></pre></div>
<p>Simulate some “cells” and “genes” that nearly form a superset of the
cells for which repertoire are available. This is generally true if no
barcode filters have been applied to the expression data. In practice a
few cells may have repertoire but not expression (or fail QC for
expression). We will work with the intersection of these cells.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">genes</span> <span class="op">=</span> <span class="fl">200</span>
<span class="va">cells</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">all_bc</span><span class="op">)</span>
<span class="va">array_size</span> <span class="op">=</span> <span class="va">genes</span><span class="op">*</span><span class="va">cells</span>
<span class="va">expression</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/NegBinomial.html" class="external-link">rnbinom</a></span><span class="op">(</span><span class="va">array_size</span>, size <span class="op">=</span> <span class="fl">5</span>, mu <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">genes</span>, ncol <span class="op">=</span> <span class="va">cells</span><span class="op">)</span>
<span class="va">sce</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/SingleCellExperiment.html" class="external-link">SingleCellExperiment</a></span><span class="op">(</span>assay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="va">expression</span><span class="op">)</span>, colData <span class="op">=</span> <span class="va">all_bc</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="remake-the-contigcelldb-with-empty-cells">Remake the ContigCellDB with empty cells<a class="anchor" aria-label="anchor" href="#remake-the-contigcelldb-with-empty-cells"></a>
</h2>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ccdb2</span> <span class="op">=</span> <span class="fu"><a href="../reference/ccdb_join.html">ccdb_join</a></span><span class="op">(</span><span class="va">sce</span>, <span class="va">ccdb_ex</span><span class="op">)</span>

<span class="va">ccdb2</span> <span class="op">=</span> <span class="fu"><a href="../reference/cdhit_ccdb.html">cdhit_ccdb</a></span><span class="op">(</span><span class="va">ccdb2</span>, <span class="st">'cdr3'</span>, type <span class="op">=</span> <span class="st">'AA'</span>, cluster_pk <span class="op">=</span> <span class="st">'aa80'</span>, identity <span class="op">=</span> <span class="fl">.8</span>, min_length <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="va">ccdb2</span> <span class="op">=</span> <span class="fu"><a href="../reference/fine_clustering.html">fine_clustering</a></span><span class="op">(</span><span class="va">ccdb2</span>, sequence_key <span class="op">=</span> <span class="st">'cdr3'</span>, type <span class="op">=</span> <span class="st">'AA'</span>, keep_clustering_details <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; Calculating intradistances on 993 clusters.</span>
<span class="co">#&gt; Summarizing</span></code></pre></div>
<p>The <code>ccdb_join(template, ccdb)</code> function does a left join
of the <code>template</code> onto the <code>cell_tbl</code> of the
<code>ccdb</code>. This will ensure that the <code>cell_tbl</code> is
expanded and ordered properly to mesh with <code>sce</code> when we add
it below.</p>
</div>
<div class="section level2">
<h2 id="chain-pairings">Chain pairings<a class="anchor" aria-label="anchor" href="#chain-pairings"></a>
</h2>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">$</span><span class="va">alpha</span> <span class="op">=</span>  <span class="fu"><a href="../reference/canonicalize_cell.html">canonicalize_cell</a></span><span class="op">(</span><span class="va">ccdb2</span>, <span class="va">chain</span> <span class="op">==</span> <span class="st">'TRA'</span>, contig_fields <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'chain'</span>, <span class="st">'v_gene'</span>,<span class="st">'d_gene'</span>, <span class="st">'j_gene'</span>, <span class="st">'aa80'</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">$</span><span class="va">beta</span> <span class="op">=</span>  <span class="fu"><a href="../reference/canonicalize_cell.html">canonicalize_cell</a></span><span class="op">(</span><span class="va">ccdb2</span>, <span class="va">chain</span> <span class="op">==</span> <span class="st">'TRB'</span>, contig_fields <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'chain'</span>, <span class="st">'v_gene'</span>,<span class="st">'d_gene'</span>, <span class="st">'j_gene'</span>, <span class="st">'aa80'</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">$</span><span class="va">pairing</span> <span class="op">=</span> <span class="fu"><a href="../reference/enumerate_pairing.html">enumerate_pairing</a></span><span class="op">(</span><span class="va">ccdb2</span>, chain_recode_fun <span class="op">=</span> <span class="st">'guess'</span><span class="op">)</span></code></pre></div>
<p>We can add multiple views, represented as fields in the
<code>colData(sce)</code> of the repertoire.</p>
</div>
<div class="section level2">
<h2 id="visualization-of-tcr-features-with-scater">Visualization of TCR features with Scater<a class="anchor" aria-label="anchor" href="#visualization-of-tcr-features-with-scater"></a>
</h2>
<p>We can leverage Scater’s ability to use “nested” data frames to
visualize TCR features.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://bioconductor.org/packages/scater/" class="external-link">scater</a></span><span class="op">)</span>
<span class="co">#&gt; Loading required package: scuttle</span>
<span class="va">sce</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/scuttle/man/logNormCounts.html" class="external-link">logNormCounts</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span>
<span class="va">sce</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/scater/man/runPCA.html" class="external-link">runPCA</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/scater/man/plotReducedDim.html" class="external-link">plotReducedDim</a></span><span class="op">(</span><span class="va">sce</span>, dimred <span class="op">=</span> <span class="st">'PCA'</span>, colour_by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">sce</span><span class="op">$</span><span class="va">pairing</span><span class="op">$</span><span class="va">pairing</span><span class="op">)</span>, point_alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<p><img src="repertoire_and_expression_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>Here we calculate the first two principal components (which aren’t
very interesting because these are simulated data without any special
structure), and then visualize if the TCR was paired or not.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">only_paired</span> <span class="op">=</span> <span class="va">sce</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">sce</span><span class="op">$</span><span class="va">pairing</span><span class="op">$</span><span class="va">pairing</span> <span class="op">==</span> <span class="st">'paired'</span><span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/pkg/scater/man/plotReducedDim.html" class="external-link">plotReducedDim</a></span><span class="op">(</span><span class="va">only_paired</span>, dimred <span class="op">=</span> <span class="st">'PCA'</span>, colour_by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">only_paired</span><span class="op">$</span><span class="va">alpha</span><span class="op">$</span><span class="va">j_gene</span><span class="op">)</span>, point_alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="co">#&gt; Warning: Removed 328 rows containing missing values (geom_point).</span></code></pre></div>
<p><img src="repertoire_and_expression_files/figure-html/unnamed-chunk-7-1.png" width="500px" height="500px"></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/scater/man/plotReducedDim.html" class="external-link">plotReducedDim</a></span><span class="op">(</span><span class="va">only_paired</span>, dimred <span class="op">=</span> <span class="st">'PCA'</span>, colour_by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">only_paired</span><span class="op">$</span><span class="va">beta</span><span class="op">$</span><span class="va">j_gene</span><span class="op">)</span>, point_alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<p><img src="repertoire_and_expression_files/figure-html/unnamed-chunk-7-2.png" width="500px" height="500px"></p>
<p>Since the <code>ContigCellDB</code> is nested within the
<code>SingleCellExperiment</code> it automatically gets subsetted
appropriately when the parent object is subsetted. Enough
<code>data.frame</code>-like semantics have been implemented so that
fields from the <code>cell_tbl</code> can be visualized.</p>
</div>
<div class="section level2">
<h2 id="colophone">Colophone<a class="anchor" aria-label="anchor" href="#colophone"></a>
</h2>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; R version 4.1.2 (2021-11-01)</span>
<span class="co">#&gt; Platform: aarch64-apple-darwin20 (64-bit)</span>
<span class="co">#&gt; Running under: macOS Monterey 12.3.1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Matrix products: default</span>
<span class="co">#&gt; BLAS:   /Library/Frameworks/R.framework/Versions/4.1-arm64/Resources/lib/libRblas.0.dylib</span>
<span class="co">#&gt; LAPACK: /Library/Frameworks/R.framework/Versions/4.1-arm64/Resources/lib/libRlapack.dylib</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; locale:</span>
<span class="co">#&gt; [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; attached base packages:</span>
<span class="co">#&gt; [1] stats4    stats     graphics  grDevices utils     datasets  methods  </span>
<span class="co">#&gt; [8] base     </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; other attached packages:</span>
<span class="co">#&gt;  [1] scater_1.22.0               scuttle_1.4.0              </span>
<span class="co">#&gt;  [3] purrr_0.3.4                 stringr_1.4.0              </span>
<span class="co">#&gt;  [5] tidyr_1.2.0                 readr_2.1.2                </span>
<span class="co">#&gt;  [7] ggplot2_3.3.5               dplyr_1.0.8                </span>
<span class="co">#&gt;  [9] SingleCellExperiment_1.16.0 SummarizedExperiment_1.24.0</span>
<span class="co">#&gt; [11] Biobase_2.54.0              GenomicRanges_1.46.1       </span>
<span class="co">#&gt; [13] GenomeInfoDb_1.30.1         IRanges_2.28.0             </span>
<span class="co">#&gt; [15] S4Vectors_0.32.3            BiocGenerics_0.40.0        </span>
<span class="co">#&gt; [17] MatrixGenerics_1.6.0        matrixStats_0.61.0         </span>
<span class="co">#&gt; [19] CellaRepertorium_1.7.1      BiocStyle_2.22.0           </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; loaded via a namespace (and not attached):</span>
<span class="co">#&gt;  [1] bitops_1.0-7              fs_1.5.2                 </span>
<span class="co">#&gt;  [3] rprojroot_2.0.2           tools_4.1.2              </span>
<span class="co">#&gt;  [5] bslib_0.3.1               irlba_2.3.5              </span>
<span class="co">#&gt;  [7] utf8_1.2.2                R6_2.5.1                 </span>
<span class="co">#&gt;  [9] vipor_0.4.5               DBI_1.1.2                </span>
<span class="co">#&gt; [11] colorspace_2.0-3          withr_2.5.0              </span>
<span class="co">#&gt; [13] gridExtra_2.3             tidyselect_1.1.2         </span>
<span class="co">#&gt; [15] compiler_4.1.2            textshaping_0.3.6        </span>
<span class="co">#&gt; [17] cli_3.2.0                 BiocNeighbors_1.12.0     </span>
<span class="co">#&gt; [19] desc_1.4.1                DelayedArray_0.20.0      </span>
<span class="co">#&gt; [21] labeling_0.4.2            bookdown_0.25            </span>
<span class="co">#&gt; [23] sass_0.4.1                scales_1.1.1             </span>
<span class="co">#&gt; [25] pkgdown_2.0.2             systemfonts_1.0.4        </span>
<span class="co">#&gt; [27] digest_0.6.29             rmarkdown_2.13           </span>
<span class="co">#&gt; [29] XVector_0.34.0            pkgconfig_2.0.3          </span>
<span class="co">#&gt; [31] htmltools_0.5.2           sparseMatrixStats_1.6.0  </span>
<span class="co">#&gt; [33] highr_0.9                 fastmap_1.1.0            </span>
<span class="co">#&gt; [35] rlang_1.0.2               rstudioapi_0.13          </span>
<span class="co">#&gt; [37] DelayedMatrixStats_1.16.0 farver_2.1.0             </span>
<span class="co">#&gt; [39] jquerylib_0.1.4           generics_0.1.2           </span>
<span class="co">#&gt; [41] jsonlite_1.8.0            BiocParallel_1.28.3      </span>
<span class="co">#&gt; [43] RCurl_1.98-1.6            magrittr_2.0.2           </span>
<span class="co">#&gt; [45] BiocSingular_1.10.0       GenomeInfoDbData_1.2.7   </span>
<span class="co">#&gt; [47] Matrix_1.3-4              ggbeeswarm_0.6.0         </span>
<span class="co">#&gt; [49] Rcpp_1.0.8                munsell_0.5.0            </span>
<span class="co">#&gt; [51] fansi_1.0.2               viridis_0.6.2            </span>
<span class="co">#&gt; [53] lifecycle_1.0.1           stringi_1.7.6            </span>
<span class="co">#&gt; [55] yaml_2.3.5                zlibbioc_1.40.0          </span>
<span class="co">#&gt; [57] grid_4.1.2                ggrepel_0.9.1            </span>
<span class="co">#&gt; [59] parallel_4.1.2            forcats_0.5.1            </span>
<span class="co">#&gt; [61] crayon_1.5.0              lattice_0.20-45          </span>
<span class="co">#&gt; [63] cowplot_1.1.1             Biostrings_2.62.0        </span>
<span class="co">#&gt; [65] beachmat_2.10.0           hms_1.1.1                </span>
<span class="co">#&gt; [67] knitr_1.37                pillar_1.7.0             </span>
<span class="co">#&gt; [69] ScaledMatrix_1.2.0        glue_1.6.2               </span>
<span class="co">#&gt; [71] evaluate_0.15             BiocManager_1.30.16      </span>
<span class="co">#&gt; [73] vctrs_0.3.8               tzdb_0.2.0               </span>
<span class="co">#&gt; [75] gtable_0.3.0              assertthat_0.2.1         </span>
<span class="co">#&gt; [77] cachem_1.0.6              xfun_0.30                </span>
<span class="co">#&gt; [79] rsvd_1.0.5                viridisLite_0.4.0        </span>
<span class="co">#&gt; [81] ragg_1.2.2                tibble_3.1.6             </span>
<span class="co">#&gt; [83] beeswarm_0.4.0            memoise_2.0.1            </span>
<span class="co">#&gt; [85] ellipsis_0.3.2</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Andrew McDavid, Yu Gu, Erik VonKaenel, Aaron Wagner.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a>
2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
