<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quality control and Exploration of UMI-based repertoire data • CellaRepertorium</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Quality control and Exploration of UMI-based repertoire data">
<meta property="og:description" content="CellaRepertorium">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">CellaRepertorium</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.7.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/cdr3_clustering.html">Clustering and differential usage of repertoire CDR3 sequences</a>
    </li>
    <li>
      <a href="../articles/cr-overview.html">An Introduction to CellaRepertorium</a>
    </li>
    <li>
      <a href="../articles/mouse_tcell_qc.html">Quality control and Exploration of UMI-based repertoire data</a>
    </li>
    <li>
      <a href="../articles/repertoire_and_expression.html">Combining Repertoire with Expression with SingleCellExperiment</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/amcdavid/CellaRepertorium/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Quality control and Exploration of UMI-based
repertoire data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/amcdavid/CellaRepertorium/blob/HEAD/vignettes/mouse_tcell_qc.Rmd" class="external-link"><code>vignettes/mouse_tcell_qc.Rmd</code></a></small>
      <div class="hidden name"><code>mouse_tcell_qc.Rmd</code></div>

    </div>

    
    
<p>This vignette shows an example of loading data from the CellRanger
pipeline and doing some QC to pick barcodes. If gene expression was also
collected, it is better to do joint cell calling.<br>
Some types of multiplets / debris can be better assessed with by using
the gene expression data. See
<code><a href="../articles/repertoire_and_expression.html">vignette('repertoire_and_expression')</a></code> for details of how to
merge repertoire with a <code>SingleCellExperiment</code> object.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/amcdavid/CellaRepertorium" class="external-link">CellaRepertorium</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'dplyr'</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter, lag</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, setdiff, setequal, union</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org" class="external-link">readr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></code></pre></div>
<div class="section level2">
<h2 id="load-contig-files">Load contig files<a class="anchor" aria-label="anchor" href="#load-contig-files"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">files</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'extdata'</span>, package <span class="op">=</span> <span class="st">'CellaRepertorium'</span><span class="op">)</span>, pattern <span class="op">=</span> <span class="st">"all_contig_annotations_.+?.csv.xz"</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co"># Pull out sample and population names</span>
<span class="va">samp_map</span> <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>anno_file <span class="op">=</span> <span class="va">files</span>, pop <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_match.html" class="external-link">str_match</a></span><span class="op">(</span><span class="va">files</span>, <span class="st">'b6|balbc'</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, sample <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_match.html" class="external-link">str_match</a></span><span class="op">(</span><span class="va">files</span>, <span class="st">'_([0-9])\\.'</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>

<span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">samp_map</span><span class="op">)</span></code></pre></div>
<table class="table">
<colgroup>
<col width="92%">
<col width="3%">
<col width="4%">
</colgroup>
<thead><tr class="header">
<th align="left">anno_file</th>
<th align="left">pop</th>
<th align="left">sample</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">/private/var/folders/7m/c_l3kv2d2z118lwkj5jpy2h40000gn/T/RtmpTNeai5/temp_libpathf7cb3d4472ec/CellaRepertorium/extdata/all_contig_annotations_b6_4.csv.xz</td>
<td align="left">b6</td>
<td align="left">4</td>
</tr>
<tr class="even">
<td align="left">/private/var/folders/7m/c_l3kv2d2z118lwkj5jpy2h40000gn/T/RtmpTNeai5/temp_libpathf7cb3d4472ec/CellaRepertorium/extdata/all_contig_annotations_b6_5.csv.xz</td>
<td align="left">b6</td>
<td align="left">5</td>
</tr>
<tr class="odd">
<td align="left">/private/var/folders/7m/c_l3kv2d2z118lwkj5jpy2h40000gn/T/RtmpTNeai5/temp_libpathf7cb3d4472ec/CellaRepertorium/extdata/all_contig_annotations_b6_6.csv.xz</td>
<td align="left">b6</td>
<td align="left">6</td>
</tr>
<tr class="even">
<td align="left">/private/var/folders/7m/c_l3kv2d2z118lwkj5jpy2h40000gn/T/RtmpTNeai5/temp_libpathf7cb3d4472ec/CellaRepertorium/extdata/all_contig_annotations_balbc_1.csv.xz</td>
<td align="left">balbc</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">/private/var/folders/7m/c_l3kv2d2z118lwkj5jpy2h40000gn/T/RtmpTNeai5/temp_libpathf7cb3d4472ec/CellaRepertorium/extdata/all_contig_annotations_balbc_2.csv.xz</td>
<td align="left">balbc</td>
<td align="left">2</td>
</tr>
<tr class="even">
<td align="left">/private/var/folders/7m/c_l3kv2d2z118lwkj5jpy2h40000gn/T/RtmpTNeai5/temp_libpathf7cb3d4472ec/CellaRepertorium/extdata/all_contig_annotations_balbc_3.csv.xz</td>
<td align="left">balbc</td>
<td align="left">3</td>
</tr>
</tbody>
</table>
<p>PBMC pooled from BALB/c and C57BL/6 mice <a href="https://support.10xgenomics.com/single-cell-vdj/datasets/3.0.0/vdj_v1_mm_c57bl6_pbmc_t" class="external-link">were
assayed on 10X genomics V3 chemistry</a> and a library enriched for TCR
were run. For the purposes of illustrating functionality in this
package, cell barcodes were subsampled 3 times for each of the BALB/c
and Black6 pools to generate distinct <code>samples</code>, which is
reflected in the <code>sample</code> column. More details are available
in the scripts in the <code>script</code> directory of this package.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># read in CSV</span>
<span class="va">all_anno</span> <span class="op">=</span> <span class="va">samp_map</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html" class="external-link">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>anno <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="va">anno_file</span>, col_types <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/cols.html" class="external-link">cols</a></span><span class="op">(</span>
  barcode <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html" class="external-link">col_character</a></span><span class="op">(</span><span class="op">)</span>,
  is_cell <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html" class="external-link">col_logical</a></span><span class="op">(</span><span class="op">)</span>,
  contig_id <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html" class="external-link">col_character</a></span><span class="op">(</span><span class="op">)</span>,
  high_confidence <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html" class="external-link">col_logical</a></span><span class="op">(</span><span class="op">)</span>,
  length <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html" class="external-link">col_double</a></span><span class="op">(</span><span class="op">)</span>,
  chain <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html" class="external-link">col_character</a></span><span class="op">(</span><span class="op">)</span>,
  v_gene <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html" class="external-link">col_character</a></span><span class="op">(</span><span class="op">)</span>,
  d_gene <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html" class="external-link">col_character</a></span><span class="op">(</span><span class="op">)</span>,
  j_gene <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html" class="external-link">col_character</a></span><span class="op">(</span><span class="op">)</span>,
  c_gene <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html" class="external-link">col_character</a></span><span class="op">(</span><span class="op">)</span>,
  full_length <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html" class="external-link">col_logical</a></span><span class="op">(</span><span class="op">)</span>,
  productive <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html" class="external-link">col_character</a></span><span class="op">(</span><span class="op">)</span>,
  cdr3 <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html" class="external-link">col_character</a></span><span class="op">(</span><span class="op">)</span>,
  cdr3_nt <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html" class="external-link">col_character</a></span><span class="op">(</span><span class="op">)</span>,
  reads <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html" class="external-link">col_double</a></span><span class="op">(</span><span class="op">)</span>,
  umis <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html" class="external-link">col_double</a></span><span class="op">(</span><span class="op">)</span>,
  raw_clonotype_id <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html" class="external-link">col_character</a></span><span class="op">(</span><span class="op">)</span>,
  raw_consensus_id <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html" class="external-link">col_character</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">all_anno</span> <span class="op">=</span> <span class="va">all_anno</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html" class="external-link">c</a></span><span class="op">(</span><span class="va">anno</span><span class="op">)</span><span class="op">)</span> </code></pre></div>
<p>(The column types typically don’t need to be specified in such
detail, but watch for issues in the <code>high_confidence</code>,
<code>is_cell</code> and <code>full_length</code> columns which may be
read as a character vs logical depending on your specific inputs. Either
is fine, but you will want to be consistent across files.)</p>
<p>We read in several files of annotated “contigs” output from 10X
genomics VDJ version 3.0.</p>
<p>The pipeline for assembling reads into contigs, and mapping them to
UMIs and cells is described in <a href="https://support.10xgenomics.com/single-cell-vdj/software/pipelines/latest/algorithms/overview" class="external-link">the
10X genomics documentation</a>, and its source code is available <a href="https://github.com/10XGenomics/cellranger/tree/5f5a6293bbc067e1965e50f0277286914b96c908" class="external-link">here</a>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cell_tbl</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">all_anno</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"barcode"</span>,<span class="st">"pop"</span>,<span class="st">"sample"</span>,<span class="st">"is_cell"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="va">cdb</span> <span class="op">=</span> <span class="fu"><a href="../reference/ContigCellDB-fun.html">ContigCellDB</a></span><span class="op">(</span><span class="va">all_anno</span>, contig_pk <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'barcode'</span>,<span class="st">'pop'</span>,<span class="st">'sample'</span>,<span class="st">'contig_id'</span><span class="op">)</span>, cell_tbl <span class="op">=</span> <span class="va">cell_tbl</span>, cell_pk <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'barcode'</span>,<span class="st">'pop'</span>,<span class="st">'sample'</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Note that initially there are 3818 contigs.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cdb</span> <span class="op">=</span> <span class="fu"><a href="../reference/mutate_cdb.html">mutate_cdb</a></span><span class="op">(</span><span class="va">cdb</span>, celltype <span class="op">=</span> <span class="fu"><a href="../reference/guess_celltype.html">guess_celltype</a></span><span class="op">(</span><span class="va">chain</span><span class="op">)</span><span class="op">)</span>
<span class="va">cdb</span> <span class="op">=</span> <span class="fu"><a href="../reference/mutate_cdb.html">filter_cdb</a></span><span class="op">(</span><span class="va">cdb</span>, <span class="va">high_confidence</span><span class="op">)</span></code></pre></div>
<p>After filtering for only high_confidence contigs there are 2731
contigs.</p>
<p>We read in the contig annotation file for each of the samples, and
annotate the contig as a alpha-beta T cell, gamma-delta T cell, B cell
or chimeric “multi” cell type based on where various</p>
</div>
<div class="section level2">
<h2 id="high-confidence-umis-belonging-to-t-cells-per-cell">High confidence UMIs belonging to T cells per cell<a class="anchor" aria-label="anchor" href="#high-confidence-umis-belonging-to-t-cells-per-cell"></a>
</h2>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">total_umi</span> <span class="op">=</span> <span class="fu"><a href="../reference/crosstab_by_celltype.html">crosstab_by_celltype</a></span><span class="op">(</span><span class="va">cdb</span><span class="op">)</span>
<span class="va">T_ab_umi</span> <span class="op">=</span> <span class="va">total_umi</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html" class="external-link">c</a></span><span class="op">(</span><span class="va">cdb</span><span class="op">$</span><span class="va">cell_pk</span>,<span class="st">"is_cell"</span>,<span class="st">"T_ab"</span><span class="op">)</span><span class="op">]</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">T_ab_umi</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">is_cell</span><span class="op">)</span>, x <span class="op">=</span> <span class="va">T_ab</span>, group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/interaction.html" class="external-link">interaction</a></span><span class="op">(</span><span class="va">is_cell</span>, <span class="va">sample</span>, <span class="va">pop</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/stat_ecdf.html" class="external-link">stat_ecdf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">'Fraction of barcodes'</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_discrete.html" class="external-link">scale_color_discrete</a></span><span class="op">(</span><span class="st">'10X called cell?'</span><span class="op">)</span></code></pre></div>
<p><img src="mouse_tcell_qc_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>10X defines <a href="https://support.10xgenomics.com/single-cell-vdj/software/pipelines/latest/algorithms/cell-calling" class="external-link">a
procedure</a> to separate cells from background that fits a Gaussian
mixture model to the UMI distributions for each sample. However in some
cases, it may be desirable to implement a common QC threshold with a
different stringency, such as:</p>
<ul>
<li>Comparing across multiple samples</li>
<li>When a sample has been enriched for a particular cell type (eg with
pre-sequencing flow cytometry).</li>
</ul>
<p>When we consider only high confidence UMIs that unambiguous map to T
cells, most “non cells” have 1 or fewer, while most putative cells have
&gt;5. However, we might want to adopt a different UMI-based cell
filter, as was done below.</p>
<!-- Is there a way to evaluate a sensitivity/specificity in distinguishing cells from debris, or T cells from other cell types? -->
</div>
<div class="section level2">
<h2 id="reads-umis">Reads / UMIs<a class="anchor" aria-label="anchor" href="#reads-umis"></a>
</h2>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">qual_plot</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">cdb</span><span class="op">$</span><span class="va">contig_tbl</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">celltype</span>, y<span class="op">=</span> <span class="va">umis</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_violin.html" class="external-link">geom_violin</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html" class="external-link">geom_jitter</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">sample</span> <span class="op">+</span> <span class="va">pop</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Annotated cell type"</span><span class="op">)</span>

<span class="va">qual_plot</span> 
<span class="co">#&gt; Warning: Groups with fewer than two data points have been dropped.</span>
<span class="co">#&gt; Groups with fewer than two data points have been dropped.</span>
<span class="co">#&gt; Groups with fewer than two data points have been dropped.</span></code></pre></div>
<p><img src="mouse_tcell_qc_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">qual_plot</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">reads</span><span class="op">)</span>
<span class="co">#&gt; Warning: Groups with fewer than two data points have been dropped.</span>
<span class="co">#&gt; Groups with fewer than two data points have been dropped.</span>
<span class="co">#&gt; Groups with fewer than two data points have been dropped.</span></code></pre></div>
<p><img src="mouse_tcell_qc_files/figure-html/unnamed-chunk-7-2.png" width="700"></p>
<p>The number of UMIs and reads by sample and annotated cell type.</p>
</div>
<div class="section level2">
<h2 id="apply-t-cell-contig-umi-filter">Apply T-cell contig UMI filter<a class="anchor" aria-label="anchor" href="#apply-t-cell-contig-umi-filter"></a>
</h2>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># At least 2 UMI mapping to high confidence T cell contigs.</span>
<span class="va">good_bc</span> <span class="op">=</span> <span class="va">total_umi</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">is_cell</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">T_ab</span> <span class="op">&gt;=</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">total_cells</span> <span class="op">=</span> <span class="va">good_bc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">sample</span>, <span class="va">pop</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>good_bc <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` has grouped output by 'sample'. You can override using the</span>
<span class="co">#&gt; `.groups` argument.</span>
<span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">total_cells</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">sample</th>
<th align="left">pop</th>
<th align="right">good_bc</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="left">balbc</td>
<td align="right">133</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">balbc</td>
<td align="right">137</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="left">balbc</td>
<td align="right">143</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="left">b6</td>
<td align="right">149</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="left">b6</td>
<td align="right">150</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">b6</td>
<td align="right">148</td>
</tr>
</tbody>
</table>
<p>Apply a filter on UMIs.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">contigs_qc</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html" class="external-link">semi_join</a></span><span class="op">(</span><span class="va">cdb</span><span class="op">$</span><span class="va">contig_tbl</span>, <span class="va">good_bc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">sample</span>, <span class="va">pop</span>, <span class="va">barcode</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">full_length</span>, <span class="va">productive</span> <span class="op">==</span> <span class="st">'True'</span>, <span class="va">high_confidence</span>, <span class="va">chain</span> <span class="op">!=</span> <span class="st">'Multi'</span><span class="op">)</span>
<span class="co">#&gt; Joining, by = c("pop", "sample", "barcode")</span></code></pre></div>
<p>And take only high confidence, full length, productive <span class="math inline">\(\alpha-\beta\)</span> T cell contigs.</p>
</div>
<div class="section level2">
<h2 id="colophone">Colophone<a class="anchor" aria-label="anchor" href="#colophone"></a>
</h2>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; R version 4.1.2 (2021-11-01)</span>
<span class="co">#&gt; Platform: aarch64-apple-darwin20 (64-bit)</span>
<span class="co">#&gt; Running under: macOS Monterey 12.3.1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Matrix products: default</span>
<span class="co">#&gt; BLAS:   /Library/Frameworks/R.framework/Versions/4.1-arm64/Resources/lib/libRblas.0.dylib</span>
<span class="co">#&gt; LAPACK: /Library/Frameworks/R.framework/Versions/4.1-arm64/Resources/lib/libRlapack.dylib</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; locale:</span>
<span class="co">#&gt; [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; attached base packages:</span>
<span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; other attached packages:</span>
<span class="co">#&gt; [1] stringr_1.4.0          tidyr_1.2.0            readr_2.1.2           </span>
<span class="co">#&gt; [4] ggplot2_3.3.5          dplyr_1.0.8            CellaRepertorium_1.7.1</span>
<span class="co">#&gt; [7] BiocStyle_2.22.0      </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; loaded via a namespace (and not attached):</span>
<span class="co">#&gt;  [1] Rcpp_1.0.8             Biostrings_2.62.0      assertthat_0.2.1      </span>
<span class="co">#&gt;  [4] rprojroot_2.0.2        digest_0.6.29          utf8_1.2.2            </span>
<span class="co">#&gt;  [7] R6_2.5.1               GenomeInfoDb_1.30.1    stats4_4.1.2          </span>
<span class="co">#&gt; [10] evaluate_0.15          highr_0.9              pillar_1.7.0          </span>
<span class="co">#&gt; [13] zlibbioc_1.40.0        rlang_1.0.2            rstudioapi_0.13       </span>
<span class="co">#&gt; [16] jquerylib_0.1.4        S4Vectors_0.32.3       rmarkdown_2.13        </span>
<span class="co">#&gt; [19] pkgdown_2.0.2          labeling_0.4.2         textshaping_0.3.6     </span>
<span class="co">#&gt; [22] desc_1.4.1             bit_4.0.4              RCurl_1.98-1.6        </span>
<span class="co">#&gt; [25] munsell_0.5.0          compiler_4.1.2         xfun_0.30             </span>
<span class="co">#&gt; [28] pkgconfig_2.0.3        systemfonts_1.0.4      BiocGenerics_0.40.0   </span>
<span class="co">#&gt; [31] htmltools_0.5.2        tidyselect_1.1.2       tibble_3.1.6          </span>
<span class="co">#&gt; [34] GenomeInfoDbData_1.2.7 bookdown_0.25          IRanges_2.28.0        </span>
<span class="co">#&gt; [37] fansi_1.0.2            tzdb_0.2.0             crayon_1.5.0          </span>
<span class="co">#&gt; [40] withr_2.5.0            bitops_1.0-7           grid_4.1.2            </span>
<span class="co">#&gt; [43] jsonlite_1.8.0         gtable_0.3.0           lifecycle_1.0.1       </span>
<span class="co">#&gt; [46] DBI_1.1.2              magrittr_2.0.2         scales_1.1.1          </span>
<span class="co">#&gt; [49] vroom_1.5.7            cli_3.2.0              stringi_1.7.6         </span>
<span class="co">#&gt; [52] cachem_1.0.6           farver_2.1.0           XVector_0.34.0        </span>
<span class="co">#&gt; [55] fs_1.5.2               bslib_0.3.1            ellipsis_0.3.2        </span>
<span class="co">#&gt; [58] ragg_1.2.2             generics_0.1.2         vctrs_0.3.8           </span>
<span class="co">#&gt; [61] tools_4.1.2            bit64_4.0.5            glue_1.6.2            </span>
<span class="co">#&gt; [64] purrr_0.3.4            hms_1.1.1              parallel_4.1.2        </span>
<span class="co">#&gt; [67] fastmap_1.1.0          yaml_2.3.5             colorspace_2.0-3      </span>
<span class="co">#&gt; [70] BiocManager_1.30.16    memoise_2.0.1          knitr_1.37            </span>
<span class="co">#&gt; [73] sass_0.4.1</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Andrew McDavid, Yu Gu, Erik VonKaenel, Aaron Wagner.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a>
2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
