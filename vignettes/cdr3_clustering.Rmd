---
title: "Clustering repertoire via CDR3 sequences"
output: BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{Clustering repertoire via CDR3 sequences}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>")
```

```{r setup}
#load_all()
library(CellaRepertorium)
library(dplyr)
library(ggplot2)
library(readr)
library(tidyr)
library(stringr)
library(purrr)
```

# Load filtered contig files

```{r}
data(contigs_qc)
MIN_CDR3_AA = 6


cdb = ContigCellDB_10XVDJ(contigs_qc, contig_pk = c('barcode', 'pop', 'sample', 'contig_id'), cell_pk = c('barcode', 'pop', 'sample'))

cdb$contig_tbl = dplyr::filter(cdb$contig_tbl, full_length, productive == 'True', high_confidence, chain != 'Multi', str_length(cdr3) > MIN_CDR3_AA) %>% mutate( fancy_name = fancy_name_contigs(., str_c(pop, '_', sample)))

```

`r nrow(cdb)` good chains (either TRA or TRB); each cell can appear more than once.


# Chain pairings

```{r}
paired_chain = enumerate_pairing(cdb, chain_recode_fun = 'guess')

ggplot(paired_chain, aes(x = interaction(sample, pop), fill = pairing)) + geom_bar() + facet_wrap(~canonical, scale = 'free_x') + coord_flip() + theme_minimal()

```


# Cluster CDR3 protein sequences


```{r}

aa80 = CellaRepertorium:::cdhit_ccdb(cdb, 'cdr3', type = 'AA', cluster_name = 'aa80', identity = .8)
aa80 = fine_clustering(aa80, sequence_key = 'cdr3', type = 'AA', keep_clustering_details = TRUE)


# This maybe should be a turned into a function 
# Other plots should be considered:
# That show how clusters are split between samples, chains, etc
ggplot(aa80$cluster_tbl %>% filter(n_cluster>1) %>% gather(key, value, -aa80, -fc) , aes(x = value))+ facet_wrap(~key, scales = 'free') + geom_histogram() + scale_y_sqrt()

```

We cluster the CDR3 translated amino acid residues with the program [CD-HIT](http://weizhongli-lab.org/cdhit_suite/cgi-bin/index.cgi?cmd=cd-hit).  A sequence is included in a cluster if it matches by 100% similiarity and has the same CDR3 length.  Note that this can and should be relaxed -- especially in the beta chain we see "near clones" that only differ by a residue or two, seemingly in stylized places.


# Cluster CDR3 DNA sequences

```{r, results = 'hide'}
cdb = CellaRepertorium:::cdhit_ccdb(cdb, 'cdr3_nt', type = 'DNA', cluster_name = 'DNA97', identity = .965, min_length = MIN_CDR3_AA*3-1, G = 1)

cdb = fine_clustering(cdb, sequence_key = 'cdr3_nt', type = 'DNA')

ggplot(cdb$cluster_tbl %>% filter(n_cluster>1) %>% gather(key, value, -DNA97) , aes(x = value))+ facet_wrap(~key, scales = 'free') + geom_histogram() + scale_y_sqrt()


# Need to test if cluster_tbl is already set in this function and cdhit_ccdb and output a warning
# This should allow us to do segment testing!
germline_cluster = CellaRepertorium:::cluster_germline(cdb, segment_keys = c('v_gene', 'j_gene', 'chain'), cluster_name = 'segment_idx')

# Need methods to take intersections/unions or manually reassign contigs into clusters

# Some way to compare cluster stringency (a cluster clustering or tanglegram?)

# Also methods that pull the clustering into the contig or cell tbls
```

```{r}
library(ggdendro)

# This should be turned into a function in the package somehow
# But plot arguments will be super-variable
# Maybe just return the `hc` object?
dendro_plot = function(ccdb, idx, method = 'complete'){
    h = filter(ccdb$cluster_tbl, !!sym(ccdb$cluster_pk) == idx) %>% pull(fc) %>% .[[1]]
    quer = filter(ccdb$contig_tbl, !!sym(ccdb$cluster_pk) == idx)
    hc = hclust(as.dist(h$distance), method = method) %>% dendro_data(type = "rectangle")
    hc$labels = cbind(hc$labels, quer)
   ggplot(hc$segments, aes(x=x, y=y)) + geom_segment(aes(xend=xend, yend=yend)) + 
  theme_classic() + geom_text(data = hc$labels, aes(color = sample, label = chain), size = 3) + scale_x_continuous(breaks = NULL) + ylab('AA Distance') + xlab('')
}

to_plot = filter(aa80$cluster_tbl, n_cluster > 3)

map(to_plot$aa80, ~ dendro_plot(aa80, .))

```

```{r, eval = FALSE}
MIN_OLIGO = 4

cluster_id = cdhit_res %>% group_by(cluster_idx) %>% summarize(cdr3_representative = get_canonical_representative(cdr3, warn_if_distinct = TRUE)) 

aa_oligo = left_join(ungroup(cdhit_res), cluster_id) %>% ungroup() %>% mutate(cdr3_representative = fct_reorder(cdr3_representative, n_cluster))

aa_oligo %>% filter(n_cluster > MIN_OLIGO) %>% ungroup() %>% group_by(cluster_idx, chain, cdr3_nt) %>% summarize(`n cells observed` = n(), `n subjects observed` = length(unique(sample))) %>% DT::datatable()


```


# Oligo clones

```{r, eval = FALSE}
cluster_id = good_cluster %>% group_by(cluster_idx) %>% summarize(cdr3_representative = get_canonical_representative(cdr3, warn_if_distinct = FALSE))

oligo_clusters_all =  left_join(ungroup(good_cluster), cluster_id, by = 'cluster_idx') %>% mutate(cdr3_representative = fct_reorder(cdr3_representative, n_cluster))

oligo_clusters = filter(oligo_clusters_all , n_cluster > MIN_OLIGO) %>% arrange(desc(cdr3_representative))
oligo_clusters %>% group_by(cluster_idx, chain, cdr3_representative) %>% summarize(`n cells observed` = n(), `n subjects observed` = length(unique(sample))) %>% DT::datatable()

good_cluster_cells = good_cluster %>% group_by(dataset, barcode, chain) %>% arrange(desc(umis, reads)) %>% do(head(., 1))
```
Checking to see how many CDR3 sequences are present in expanded clonotypes. Expect only 1.

***

```{r, eval = FALSE}
oligo_plot = ggplot(oligo_clusters, aes(x = str_c(cdr3_representative, '; ', v_gene, ':', j_gene), fill = chain)) + geom_bar() + coord_flip() + scale_fill_brewer(type = 'qual') + theme_minimal()
oligo_plot
```

These always come from a single chain.

***

```{r, eval = FALSE}
oligo_plot + aes(fill =   sample) + facet_wrap(~pop)

```

But come from multiple populations and samples.

# Formal testing for frequency differences

```{r, eval = FALSE, results = 'hide'}
library(lme4)
library(broom)
per_chain_sample = good_cluster_cells %>% group_by(sample, pop, chain) %>% summarize(total_cells = n(), weeks_premature = weeks_premature[1])

oligo_cluster_stat = semi_join(oligo_clusters, good_cluster_cells %>% select(dataset, contig_id)) %>% group_by(sample, pop, chain, cluster_idx) %>% summarize(n_cluster = n())%>% ungroup() %>% complete(sample, pop, nesting(cluster_idx, chain), fill = list(n_cluster = 0))

oligo_cluster_stat = left_join(oligo_cluster_stat, per_chain_sample, by = c('sample', 'pop', 'chain')) 

stopifnot( all(colSums(with(oligo_cluster_stat, table(chain, cluster_idx)) > 0) == 1))

mm_out = suppressWarnings(oligo_cluster_stat %>% group_by(cluster_idx, chain) %>% do( glmer(cbind(n_cluster, total_cells) ~ pop + weeks_premature + (1|sample), data = ., family = 'binomial') %>% tidy(conf.int = TRUE)))
```

```{r  per_iso_tests, eval = FALSE}
mm_outj = filter(left_join(ungroup(mm_out), unique(oligo_clusters_all %>% select(cdr3_representative, cluster_idx))), term %in% c('popCD31Pos', 'weeks_premature')) %>% mutate(ci_lo = AMmisc::clamp(conf.low), ci_hi = AMmisc::clamp(conf.high)) %>% arrange(desc(cdr3_representative))

ggplot(mm_outj, aes(x = cdr3_representative, ymin = ci_lo, ymax = ci_hi, y = clamp(estimate))) + geom_pointrange() + facet_wrap(~term, scales = 'free') + coord_flip() + theme_minimal() + geom_hline(yintercept = 0, lty = 2) + xlab("Isomorph") + ylab("log odds of isomorph")
```

We test if the binomial rate of clone expression differs between CD31+/- or term, for each clone.

# Clonal pairs

```{r expanded_clones, eval = FALSE}
class_colors = data_frame(chain =  unique(oligo_clusters_all$chain)) %>% mutate(class_color =  brewer.pal(length(chain),"Set1")[-1])

feature_tbl = oligo_clusters_all %>% group_by(cdr3_representative) %>% summarize(chain = chain[1], v_gene = v_gene[1], d_gene = d_gene[1]) %>% left_join(class_colors)



pairing_list = pairing_tables(oligo_clusters_all %>% select(cdr3_representative, dataset, barcode, chain, umis, reads), cluster_idx = 'cdr3_representative', cell_identifiers = c('dataset', 'barcode'), table_order = 2, orphan_level = 1, min_expansion = 2, feature_tbl = feature_tbl, cell_tbl = good_cells)

```


```{r plot_expanded, eval = FALSE}
pairs_plt = ggplot(pairing_list$cell_tbl, aes(x = cluster_idx.1_fct, y = cluster_idx.2_fct, color = sample, shape = pop)) + geom_jitter(width = .3, height = .3) + theme_minimal()

ylab = data_frame(cdr3_representative =  ggplot_build(pairs_plt)$layout$panel_params[[1]]$y.label) %>% left_join(feature_tbl) %>% mutate(class_color = ifelse(is.na(class_color), '#E41A1C', class_color))

xlab = data_frame(cdr3_representative =  ggplot_build(pairs_plt)$layout$panel_params[[1]]$x.label) %>% left_join(feature_tbl) %>% mutate(class_color = ifelse(is.na(class_color), '#E41A1C', class_color))

pairs_plt = pairs_plt + theme(axis.text.x = element_text(angle = 90, color = xlab$class_color, size = 8), axis.text.y = element_text(color = ylab$class_color, size = 8))

pairs_plt

```

## Expanded clones

```{r, eval = FALSE}
pairing_list = pairing_tables(oligo_clusters_all %>% select(cdr3_representative, dataset, barcode, chain, umis, reads), cluster_idx = 'cdr3_representative', cell_identifiers = c('dataset', 'barcode'), canonicalize_fun = canonicalize_by_prevalence, table_order = 2, orphan_level = 1, min_expansion = 4, feature_tbl = feature_tbl, cell_tbl = good_cells, cluster_whitelist = filter(oligo_clusters, n_cluster>8) %>% dplyr::select(cluster_idx.1 = cdr3_representative) %>% unique())
<<plot_expanded>>
```

# Length of CDR3


```{r eval = FALSE}

ggplot(good_cluster_cells, aes(color = pop, fill = pop, x= cdr3_length)) + geom_histogram(binwidth = 1, position = 'dodge', mapping = aes(y = ..density..)) + theme_minimal() + scale_fill_brewer(type = 'qual') + scale_color_brewer(type = 'qual')  + facet_grid(sample ~chain) + theme(strip.text.y = element_text(angle = 0)) + coord_cartesian(xlim = c(25, 55))

cdr_len = cdb %>% group_by(chain) %>% do(tidy(lmer(cdr3_length ~ (pop+Gender+weeks_premature) + (1|sample), data = .), conf.int = TRUE))
```


```{r cdr3_len, fig.width = 3, fig.height = 3, eval = FALSE}
ggplot(cdr_len %>% filter(group == 'fixed', term != '(Intercept)'), aes(x = interaction(chain, term), y = estimate, ymin = conf.low, ymax = conf.high)) + geom_pointrange() + theme_minimal() + coord_flip() + ylab('Length(CDR3 Nt)') + xlab('Term/Chain')

```




